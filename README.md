Thank you to The Browser Companys Dia chat for most of the code. 
